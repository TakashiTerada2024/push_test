# 申出様式PDFについて

# 概要
システムから出力される、申出様式PDFの内容についての資料です。

## 前提
本ドキュメント閲覧の前に、以下の2点のドキュメント内容を確認してください。
- [apply-type.md](./apply-type.md)
- [apply-status.md](./apply-status.md)

## 申出様式PDFとは何か
- 申出様式とは、全国がん情報の利用を希望する申出者が作成する書類である
- 申出様式は4種類存在する
    - 申出者が作成するべき申出様式の種類は、利用形態の区分（1.顕名/リンケージ 2.匿名/集計統計）および、利用者の区分（1.行政関係者 2.研究者等）により決定する
    - システム上では、申出様式の種類は applies.type に格納されている数値で表現される。詳細は右記ドキュメント=> [apply-type.md](./apply-type.md)
- 申出様式は、種類により一部の記入項目や添付書類等の違いがあるものの、全体としては共通の大項目によって構成されている。以下にその大項目を列挙する
    - かがみ（書類を送付する際に同封する表紙のこと）
    - 1.申出に係る情報の名称
    - 2.情報の利用目的
    - 3.提供依頼申出者及び利用者
    - 4.利用する情報の範囲
    - 5.利用する登録情報及び調査研究方法
    - 6.利用期間
    - 7.利用場所、利用する環境、保管場所及び管理方法
    - 8.調査研究成果の公表方法及び公表予定時期
    - 9.情報等の利用後の処置
    - 10.その他
    - ※1～10のセクション名は ソースコード上の Ncc01\Apply\Enterprise\Classification\QuestionSectionName にて定義
- 申出者の入力内容に応じて適切な種類の申出様式をPDFファイルとして出力することが、本システムの最も主要な機能である。
- 申出様式PDF出力機能は、appliesテーブルのデータ状態（applies.typeの格納値）に応じて出力内容を分岐させる形で実装されている。
- 4種類の申出様式のPDF出力におけるロジックは基本的に共通であり、今後も極力共通化された状態を維持する方針である。

## 関連資料
以下は、開発開始時点で提供された申請様式のサンプル4点である。
これらの資料と現状のシステムから出力されるPDFの内容に差異が認められる場合、確認の上で本ドキュメントに仕様として記載を行うこと。
https://drive.google.com/drive/u/0/folders/1OBD8sOERtyBzFHt4KWr6hl2szpky3ZDG

- 17条（行政関係者）匿名
  https://docs.google.com/document/d/13yxV047zCXgLo7ym8BRtNbJ9xlH5K8Y-/edit?usp=share_link&ouid=113264954564717787716&rtpof=true&sd=true
- 17条（行政関係者）リンケージ
  https://docs.google.com/document/d/1YkUkh2atY7mpWF7u4viGulWed-YwH8lv/edit?usp=share_link&ouid=113264954564717787716&rtpof=true&sd=true
- 21条（研究者等）匿名
  https://docs.google.com/document/d/1wtUqhY-iKgJXy8Jeaalk89dBvN-C0crB/edit?usp=share_link&ouid=113264954564717787716&rtpof=true&sd=true
- 21条（研究者等）リンケージ
  https://docs.google.com/document/d/1xyr-_fi8VpxbKdtXk7fZh0jznXcGRA_v/edit?usp=share_link&ouid=113264954564717787716&rtpof=true&sd=true

※上掲資料4点は、あくまで開発初期時点で提供された資料であるため、上掲資料の記載と本ドキュメントとの間に相違点がある場合、本ドキュメントの内容を優先する。  

# 詳細
## 申出様式PDFの構成について
前述の通り、申出様式は（その種類にかかわらず）かがみ、および1～10の大項目により構成される。以下、申出様式PDF全体、そして各セクションごとの詳細仕様を示す。

## PDF全体に関する仕様
申出様式PDF全体に関する要件を以下に列挙する。

### 「提出不可」の透かし文字の配置
- 申出者および事務局担当者が、システム入力内容の目視確認等のため、提出要件を満たしていない状態でPDFを出力したい、という要件がある。
- 提出要件を満たしていない状態でPDFを出力する場合、そのPDFが入力途中のものであるか、完成稿であるか
- 事務局への提出要件を満たしていない状態で出力する場合、PDF全体の背景に「提出不可」の透かし文字を配置する。
- 「事務局への提出要件を満たしていない状態」　のシステム上の定義について
  - 現状の実装では、「提出中以外」という判定条件となっている。
  - 正しくは、申出ステータスが 相談中、作成中、確認中 のいずれか（提出中　より前のステータスであること）ではないかと考えられる。
  - https://ganjoho-jp.backlog.com/view/NCC8_NCR_MOSHIDE-28 にて確認、整理を進行中。

### 出力を行う権限
- 申出様式PDFの出力は、以下の条件を満たすユーザーに対してのみ許可する
 - 1.申出者 権限のユーザーのうち、申出者本人のみ
 - 2.事務局 権限のユーザーすべて

### 改ページについて
以下のセクションの出力内容の末尾にて、改ページを行う
- かがみ
- 2.情報の利用目的
- 3.提供依頼申出者及び利用者
- 4.利用する情報の範囲
- 5.利用する登録情報及び調査研究方法

※上記以外については、出力内容に応じて可変。

### textareaの入力
- 入力時、textareaにて入力された状態を、出力時に再現すること。
- 特に、入力時の改行が出力時においても同様に反映されていなければならない点に注意すること。

## 各セクションにおける仕様
以下に、各セクションが満たすべき機能、要件について詳述する。（作成中）

### かがみ
- 以下の内容について出力を行う。

#### 様式名 の出力

- PDF左上 に申出種別に応じた様式名を出力する。

| 種別 | 利用者の区分 | 種別            |  出力される様式名   |
| ---- | ------------ | --------------- | :-----------------: |
| 1    | 行政関係者   | 顕名/リンケージ |  様式第2_1申出17条  |
| 2    | 行政関係者   | 匿名/集計統計   |  様式第2_1申出17条  |
| 3    | 研究者等     | 顕名/リンケージ | 様式第2-1号申出21_3 |
| 4    | 研究者等     | 匿名/集計統計   | 様式第2-1号申出21_4 |

#### 提出日 の出力

- PDF右上に、提出日を出力する。
    - 提出日とは、データベース上の applies.submitted_at を指す。

- PDF出力対象の申出に変更履歴が存在している場合、変更元となっている申出の提出日についてもあわせて出力を行う。
  - 変更履歴は、apply_histories テーブルに格納されている。
  - 変更元となっている申出のIDは、apply_histories.source_apply_id 
　- 変更申出　については [request-for-chang.md](./request-for-chang.md) も参照。

- 提出日がNULLの場合は （提出日：未定） と出力する。
  - ※PDF出力対象の申出 の提出日、変更元となっている申出の提出日、いずれについてもNULLの場合（提出日：未定）と出力
    - 変更元となっている申出は、かならず「応諾」ステータスである。
    - 「応諾」ステータスとなるためには、かならず「提出中」ステータスを経る。
    - 「提出中」ステータスとなる際に「提出日」が記録される。
    - したがって、変更元の申出には、通常かならず「提出日」が記録されている
      - しかし、2023-05-17 https://ganjoho-jp.backlog.com/view/NCC8_NCR_MOSHIDE-27 にて、変更元の申出に「提出日」が記録されていない事例の報告が上がった。これは、「変更申出」に関する仕様変更が行われる前に作成されたデータである。
      - 2023-05-17 https://ganjoho-jp.backlog.com/view/NCC8_NCR_MOSHIDE-30 にて、データ修正が実施される予定。

#### 宛先 の出力

- PDF左上部、様式名の下に、申出種別に応じた文書の宛先を出力する。出力内容は以下の通り。
 
| 種別 | 利用者の区分 | 種別            |  出力される宛先   |
| ---- | ------------ | --------------- | :-----------------: |
| 1    | 行政関係者   | 顕名/リンケージ |  厚生労働大臣 殿  |
| 2    | 行政関係者   | 匿名/集計統計   |  国立研究開発法人<br />国立がん研究センター 理事長 殿 |
| 3    | 研究者等     | 顕名/リンケージ | 厚生労働大臣 殿 |
| 4    | 研究者等     | 匿名/集計統計   | 国立研究開発法人<br />国立がん研究センター 理事長 殿 |

#### 申出者情報 の出力

-　PDF右上部、提出日の下に申出者に関する情報、および「 (押印省略) 」の表記を出力する。出力する項目は以下の通り。
-　所属：データベース上の、applies.affiliation
-　申請者名：データベース上の、applies.applicant_name

#### 申出件名　の出力

- PDF左部、宛先　の下に、申出種別に応じた申出件名を出力する。種別と出力内容の対応は以下の通り。
 
| 種別 | 利用者の区分 | 種別            |  出力される申出件名  |
| ---- | ------------ | --------------- | :-----------------: |
| 1    | 行政関係者   | 顕名/リンケージ |  全国がん登録情報の提供について（申出）  |
| 2    | 行政関係者   | 匿名/集計統計   | 匿名化が行われた全国がん登録情報の提供について（申出） |
| 3    | 研究者等     | 顕名/リンケージ | 全国がん登録情報の提供について（申出） |
| 4    | 研究者等     | 匿名/集計統計   | 匿名化が行われた全国がん登録情報の提供について（申出）|



#### 申出概要 の出力

- PDF左部、申出件名　の下に、申出概要を出力する。
- 申出概要は、基本的に申出種別に応じた定型文である。以下に種別と定型文の対応を示す。
 
| 種別 | 利用者の区分 | 種別            |  出力される申出件名  |
| ---- | ------------ | --------------- | :------------------ |
| 1    | 行政関係者   | 顕名/リンケージ |  標記について、がん登録等の推進に関する法律（平成25年法律第111号）（17条、第21条第1項、第21条第2項）の規定に基づき、別紙のとおり全国がん登録情報の提供の申出を行います。  |
| 2    | 行政関係者   | 匿名/集計統計   | 標記について、がん登録等の推進に関する法律（平成25年法律第111号）第17条の規定に基づき、別紙のとおり匿名化が行われた全国がん登録情報の提供の申出を行います。 |
| 3    | 研究者等     | 顕名/リンケージ | 標記について、がん登録等の推進に関する法律（平成25年法律第111号）第21条第3項の規定に基づき、別紙のとおり全国がん登録情報の提供の申出を行います。 |
| 4    | 研究者等     | 匿名/集計統計   | 標記について、がん登録等の推進に関する法律（平成25年法律第111号）第21条第4項の規定に基づき、別紙のとおり匿名化が行われた全国がん登録情報の提供の申出を行います。 |

- 申出概要は、前掲の定型文以外の内容となる場合がある。
    - 2023-05-11時点で、具体的に定型文以外の内容を出力しなければならない事例として把握できているのは、変更申出の場合である。

- システム仕様としては、以下の内容にて実装されている。
    - データベース上の申出概要（applies.summary）が入力されている場合、その内容を出力する
    - データベース上の申出概要（applies.summary）が入力されていない場合、デフォルト値として申出種別に応じた定型文を出力する


### 1.申出に係る情報の名称
#### 様式名 の出力
- ページ中央最上部に、様式名を出力する。
- 出力される様式名は、かがみ セクションの様式名と同等の内容。

#### 申出に係る情報の名称 の出力
- ページ左上部に、申出に係る情報の名称　を出力する。

| 種別 | 利用者の区分 | 種別            |    出力される 申出に係る情報の名称     |
| ---- | ------------ | --------------- |:----------------:|
| 1    | 行政関係者   | 顕名/リンケージ | 全国がん登録情報（非匿名化情報） |
| 2    | 行政関係者   | 匿名/集計統計   | 匿名化が行われた全国がん登録情報 |
| 3    | 研究者等     | 顕名/リンケージ | 全国がん登録情報（非匿名化情報） |
| 4    | 研究者等     | 匿名/集計統計   | 匿名化が行われた全国がん登録情報 |

#### 添付文書 情報の出力
- 申出に係る情報の名称 の下に、添付文書の添付の有無に関する情報を出力する。
- 対象となる添付文書は、以下の3種類。
  - 当該研究に係る同意取得説明文書（attachments.attachment_type_id=101）
  - 様式例第3-2号等（attachments.attachment_type_id=102）
  - 実績を示す論文・報告書等（attachments.attachment_type_id=103）
- 対象の添付資料をアップロードしている場合、チェック。アップロードしていない場合、チェックなし。

### 2.情報の利用目的
#### 利用目的　の出力
- 入力画面にて入力された利用目的 の文章を出力する。
  - データベース上、applies.2_purpose_of_use の格納値。
  - 入力時に改行されている場合、出力においても改行が反映されること。

#### 必要性 の出力
- 入力画面にて入力された利用の必要性 に関する文章を出力する。
    - データベース上、applies.2_need_to_use の格納値。
    - 入力時に改行されている場合、出力においても改行が反映されること。

   
#### 必要性（添付文書情報）の出力
- 必要性 の下に、添付文書の有無に関する情報を出力する。
- 対象となる添付文書は、以下の3項目、システム上の分類では4種類。
    - 様式例第3-1号（文書ID：201）
    - 委託の場合は委託契約書等又は様式例第4-1号 
      - 併記の形となっているが、システム上では、委託契約書と様式例第4-1号を別の実体として扱う
      - 委託契約書は、文書ID：202
      - 様式例第4-1号は、文書ID：203
    - 研究計画書等（文書ID：204）
- 対象の添付資料をアップロードしている場合、チェック。アップロードしていない場合、チェックなし。
- 「委託の場合は委託契約書等又は様式例第4-1号」については、委託契約書、または　様式例第4-1号　のいずれかがアップロードされている場合はチェック。どちらもアップロードされていない場合はチェックなし。

#### 倫理審査進捗状況　の出力
- 入力画面にて入力された倫理審査状況を出力する。
  - データベース上、applies.2_ethical_review_status の格納値。
  - 出力項目は以下の2点で、入力内容と合致する項目を、丸囲みにて表示。
    - 承認済
    - その他

#### その他を選択した場合の理由 の出力
- 以下の条件にて、入力画面にて入力された、その他を選択した場合の理由を出力する。
  - 倫理審査状況　が「承認済み」、「その他」どちらの場合でも出力する
- 出力内容は、データベース上 applies.2_ethical_review_remark の格納値
- 入力時に改行されている場合、出力においても改行が反映されること。

#### 倫理審査委員会　情報の出力
- 入力画面にて入力された倫理審査委員会 情報（名称、承認番号、承認年月日）を出力する
  - 名称は、applies.2_ethical_review_board_name の格納値
  - 承認番号は、applies.2_ethical_review_board_code の格納値
  - 承認年月日は、applies.2_ethical_review_board_date の格納値
    
### 3.提供依頼申出者及び利用者
#### 提供依頼申出者の情報　出力
- 入力画面にて入力された、申出者情報を出力する。
- この項目は、入力画面において選択された「申出者の種別」が「個人」であるか「法人」であるかにより、出力内容が異なる。
- 種別が「個人」である場合
  - 氏名、住所、生年月日 の順に、3項目を出力する
    - 氏名 applies.10_applicant_name の格納値
    - 住所 applies.10_applicant_address の格納値
    - 生年月日 applies.10_applicant_birthday の格納値
- 種別が「法人」である場合
  - 代表者氏名、法人その他の団体の名称、法人その他の団体の住所　の順に、3項目を出力する
    - 代表者氏名 applies.10_applicant_name の格納値
    - 法人その他の団体の名称 applies.affiliation の格納値
    - 法人その他の団体の住所 applies.10_applicant_address の格納値
- 備考/当初、これらの提供依頼申出者情報は、10.その他　セクションに出力される予定であったが、仕様変更により当セクションに移動した。そのため、テーブルの列名prefix が 10_ となっている項目が存在する。

#### 利用者の範囲 (添付文書情報)の出力
- 提供依頼申出者の情報 の下に、添付文書の有無に関する情報を出力する。
- 対象となる添付文書は、以下の2項目、システム上の分類では3種類。
  - 様式例第2-3号及び誓約書 
    - システム上でも、様式例第2-3号及び誓約書（ID：301）はまとめて1つの実体として扱う 
  - 調査研究の一部を委託している場合は、委託契約書等又は様式例第4-2号 
    - システム上では、委託契約書（ID：303）と様式例第4-2号（ID：302）を別の実体として扱う
- 対象の添付資料をアップロードしている場合、チェック。アップロードしていない場合、チェックなし。
- 「委託契約書等又は様式例第4-2号 」については、いずれかがアップロードされている場合はチェック。どちらもアップロードされていない場合はチェックなし。
- 備考/ 本項目の委託契約書（ID：303）と、必要性（添付文書情報）における委託契約書（文書ID：202）は、システム上異なる実体として扱っているが、区別すべきものであるかの合意がなされていない。
  - 未整理となっている要件については、https://ganjoho-jp.backlog.com/view/NCC8_NCR_MOSHIDE-29 にて確認予定

#### 利用者情報 の出力
- 利用者の範囲 (添付文書情報) の下に、この申出により提供されるがん情報の利用者に関する情報を出力する。
  - 1件の申出に対して、利用者は1～複数名。
  - 本項目には、1～複数登録されている利用者すべての情報を出力する。
- 利用者1名あたりの出力項目は、氏名、所属、職名、役割　の4点。
  - 氏名 apply_users.name 
  - 所属 apply_users.institution 
  - 職名 apply_users.position 
  - 役割 apply_users.role 
  - 所属、職名、役割の3項目については、入力時に改行されている場合、出力時にも改行が反映されること

### 4.利用する情報の範囲
#### 診断年次 の出力
- 入力画面にて入力された診断年次（開始年、終了年）を出力する。
- 開始年 applies.4_year_of_diagnose_start
- 終了年 applies.4_year_of_diagnose_end

#### 地域（対象都道府県） の出力
- 入力画面にて選択された都道府県を、チェックボックス形式で出力する
  - 入力画面にて47都道府県すべてが選択されている場合、「全国」1項目をチェックありの状態で出力する
  - それ以外の場合、都道府県47項目のチェックボックスを
    - 入力画面で選択されている都道府県は、チェックありで出力する
    - 入力画面で選択されていない都道府県は、チェックなしで出力する

#### がんの種類 関連情報の出力
- 入力画面にて選択された「疾病分類」、および入力された「疾病分類詳細」を出力する。
- 疾病分類
  - 疾病分類項目は、Ncc01\Apply\Enterprise\Classification\IcdTypes にて定義
  - データベース格納値は、applies.4_idc_type
- 疾病分類詳細  
  - データベース格納値は applies.4_idc_detail
  - 入力時に改行されている場合、出力においても改行が反映されること。

#### 生存確認情報 の出力
- 入力画面にて選択されている、下記3項目の要・不要について出力する
  - 生存しているか死亡しているかの別(applies.4_is_alive_required)
  - 生存を確認した直近の日又は死亡日(applies.4_is_alive_date_required)
  - 死亡の原因(applies.4_is_cause_of_death_required)
- 入力画面にて選択されている方を丸囲みにて出力

#### 属性的範囲　関連情報の出力
- 性別
  - 入力画面にて選択された性別（男性のみ・女性のみ・両性別　のいずれか）を出力する
    - applies.4_sex
  - 備考欄に記載された内容を出力する。
    - applies.4_sex_detail
  - 備考欄については、入力時に改行されている場合、出力においても改行が反映されること。
- 年齢
  - 入力画面にて選択されている、提供情報における年齢の形式（5歳階級での提供、それ以外　のいずれか1つ）を出力する
    - applies.4_range_of_age_type
  - 備考欄に入力された内容を出力する。
    - applies.4_range_of_age_detail
  - 備考欄については、入力時に改行されている場合、出力においても改行が反映されること。
   
### 5.利用する登録情報及び調査研究方法
#### 利用する登録情報(添付文書情報)の出力
添付文書、様式例2-1 別紙（ID:501）の提出有無について出力する
- 対象の添付文書をアップロードしている場合、チェックありで表示。アップロードしていない場合、チェックなし。

#### 調査研究方法の出力
- 入力画面にて入力された、調査研究方法の内容を出力する。
- 出力内容は、データベース上 applies.5_research_method の格納値
- 入力時に改行されている場合、出力においても改行が反映されること。
 
#### 調査研究方法(添付文書情報)の出力
添付文書、集計表の様式案等（ID:502）の提出有無について出力する
- 対象の添付文書をアップロードしている場合、チェックありで表示。アップロードしていない場合、チェックなし。

### 6.利用期間
#### 利用期間の始期、終期の出力
- 始期 固定文言「情報の提供を受けた日」 を出力する
- 終期 入力画面にて入力された、終期の日付を出力する。
  - 年4桁、月2桁、日2桁、半角英数ハイフンを区切り文字として出力
  - データベース上の格納値は、applies.6_usage_period_end

※ データベースの列、applies.6_usage_period_startが存在しているが、2023-06-22現在利用されていない。利用状況精査の上で削除するべきである。 
※ applies.6_research_period_start,applies.6_research_period_end は、申出様式PDFには出力しない。

### 7.利用場所、利用する環境、保管場所及び管理方法
#### 安全管理措置 (添付文書情報)の出力
- 添付文書、安全管理措置（ID:701）の提出有無について出力する
- 対象の添付文書をアップロードしている場合、チェックありで表示。アップロードしていない場合、チェックなし。

### 8.調査研究成果の公表方法及び公表予定時期
#### 公表予定時期 の出力
- 入力画面にて入力された、公表予定時期（自由入力）の内容を出力する。
- 出力内容は、データベース上 applies.8_scheduled_to_be_announced の格納値
- 入力時に改行されている場合、出力においても改行が反映されること。

### 9.情報等の利用後の処置
#### 利用後の処置 情報の出力
- 入力画面にて入力された、利用後の処置（自由入力）の内容を出力する。
- 出力内容は、データベース上 applies.9_treatment_after_use の格納値
- 入力時に改行されている場合、出力においても改行が反映されること。

### 10.その他
#### その他必要事項 の出力
-　入力画面にて入力された、その他必要事項（自由入力）の内容を出力する。
- 出力内容は、データベース上 applies.10_remark の格納値
- 入力時に改行されている場合、出力においても改行が反映されること。

#### 事務担当者及び連絡先 の出力
- 以下の4項目の情報について出力する
  - 氏名
    - 事務担当者の氏名を出力する
    - 出力内容は、データベース上 applies.10_clerk_name の格納値
  - 連絡先住所
    - 事務担当者の連絡先住所を出力する。
    - 出力内容は、データベース上 10_clerk_contact_address の格納値
  - Eメール
    - 事務担当者のEメールアドレスを出力する。
    - 出力内容は、データベース上 applies.10_clerk_contact_email の格納値
  - 電話番号
    - 事務担当者の電話番号、および内線番号を出力する。電話番号、内線番号の間はスペースで区切る。
    - 電話番号の出力内容は、データベース上 applies.10_clerk_contact_phone_number の格納値
    - 内線番号の出力内容は、データベース上 applies.10_clerk_contact_extension_phone_number の格納値
