# 変更申出(Request for change)
作成 : 2023-02-03
更新 : 2023-05-17

# 概要
変更申出の定義について説明する。

2023-02-03MTGにおいて、国立がんセンター側から「変更申出」とは何か、についての説明があった。その内容について以下に記載する。

## 更新履歴
- 2023-05-17 「応諾」ステータスに関する経緯等、一部の記載内容について [申出ステータス](./apply-status.md) へ移動。

## 前提
- ドキュメント [申出ステータス](./apply-status.md)　の内容を確認すること。

# 詳細
## 変更申出の定義
- 「変更申出」とは、「応諾」となった申出について、その内容を変更して再度申出を行うことを指す。
- 「応諾」とは、事務局が承認し提出された申出を、審議会において審査し、審査の結果、「全国がん情報」の利用が認可されることを指す。
- したがって、以下のようなケースは「変更申出」に該当しない。
  - 1.事務局が承認せず、差し戻した場合。（審議されていないため）
  - 2.事務局が承認し、審議会にて審議が行われたが、「全国がん情報」の利用が許可されなかった場合。（「応諾」されていないため。がんセンターでは、「不応諾」と呼ばれている）
  - 3.事務局が承認し、審議会にて審議が行われたが、「全国がん情報」の利用を許可するかどうか、判断がつかなかった場合。（「応諾」されていないため。がんセンターでは、「継続審議」と呼ばれている）


## 関連backlog課題
開発当時の合意内容については、下記課題中の記載を参照。
- https://ganjoho-jp.backlog.com/view/NCC8_NCR_MOSHIDE-4
- https://ganjoho-jp.backlog.com/view/NCC8_NCR_MOSHIDE-5

## 実装上の要点
- 実装上、「変更申出」とは「変更履歴情報を持つ申出」と言い換えることができる。
- 以下に、要点についてピックアップする。 

### 主な機能要件
- 変更申出作成：ある1つの申出A を変更元として、1つの変更申出X の作成を行う
- 履歴情報の表示：ある1つの変更申出X の情報閲覧時に、Xの変更元となった（複数の）申出へのリンクを表示する
- 派生した変更申出の表示：ある1つの申出A の情報閲覧時に、申出A を変更して作成された （複数の）変更申出 へのリンクを表示する
 
### 仕様詳細の要点 
- 変更申出X を作成する際、その変更元となる　申出A は、「応諾」ステータスでなければならない。
- ある変更申出X の変更元となっている 申出A は、申出X以外の申出の変更元としては利用できない（1回のみ制限）

### 履歴情報について
- 変更申出機能を実装するにあたり、変更の履歴を情報として格納する必要が生じたため、apply_historiesテーブルを追加した。
- ある申出Xに対し、申出Xの変更元となっている申出の情報は、apply_histories.source_apply_id に格納される。
- 申出Xの履歴を検索したい場合、SQLは下記様となる

~~~sql
-- 申出Xの履歴
SELECT source_apply_id FROM apply_histories WHERE apply_id = X ORDER BY created_at ASC; 
~~~ 
 
- 具体例として、以下のような経緯を辿った場合には、申出Xの変更履歴は3レコード保存されなければならない。
  - 申出Aを変更し、申出Bを作成
  - 申出Bを変更し、申出Cを作成
  - 申出Cを変更し、申出Xを作成

- ある申出Aに対し、Aから派生した変更申出を取得する場合、SQLは以下様となる。
~~~sql
-- 申出Aを変更元とする変更申出
SELECT apply_id FROM apply_histories WHERE source_apply_id = A ORDER BY created_at ASC; 
~~~ 


※ データとしては冗長な部分があり、かついわゆるアンチパターン（隣接リスト/ナイーブツリー）の構造である  
参考 https://zenn.dev/rescuenow/articles/c7d7291f2deed8



# 備考
- 2023年度以降の機能追加において、「不応諾」「継続審議」等のステータスや、詳細な業務プロセスの効率化について検討される。

以上
