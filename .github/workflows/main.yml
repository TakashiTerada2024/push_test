name: EC2 auto deploy with Docker
on:
  pull_request:
    types:
      - closed
    branches:
      - master
  workflow_dispatch:

jobs:
  build:
    # マージされた場合または手動実行の場合のみ実行
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      # Branchをチェックアウト
      - name: Checkout code
        uses: actions/checkout@v4

      # IP取得ライブラリをインストール
      - name: Public IP Install
        id: ip
        uses: haythem/public-ip@v1.3

      # AWS CLIをインストールする
      - name: AWS CLI install
        run: |
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          sudo ./aws/install --update
          aws --version

      # AWS CLIにキーを設定する
      - name: AWS set Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1

      # セキュリティグループを開放
      - name: Open Security Group
        id: open-sg
        run: |
          aws ec2 authorize-security-group-ingress --group-id ${{ secrets.EC2_SECURITY_GROUP_ID }} --protocol tcp --port 22 --cidr ${{ steps.ip.outputs.ipv4 }}/32

      # EC2でビルドを実行
      - name: Build on EC2
        id: build
        run: |
          # 秘密鍵を設定
          cat > private_key << 'KEYEOF'
          ${{ secrets.SSH_PRIVATE_KEY }}
          KEYEOF
          chmod 600 private_key

          # 秘密鍵の確認（デバッグ用 - 内容は表示しない）
          if [ -s private_key ]; then
            echo "Private key file created successfully"
            head -n 1 private_key
          else
            echo "ERROR: Private key file is empty"
            exit 1
          fi

          # 接続情報の確認
          echo "User: ${{ secrets.EC2_USER }}"
          echo "Host: ${{ secrets.EC2_HOST }}"

          # SSH 接続してビルドを実行
          ssh -o StrictHostKeyChecking=no -i private_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          set -e

          # Git のインストール確認とインストール
          if ! command -v git &> /dev/null; then
            echo "=== Installing Git ==="
            sudo dnf install -y git
          else
            echo "=== Git is already installed ==="
          fi

          # プロジェクトディレクトリの確認とクローン/プル
          if [ -d "/home/ec2-user/ncc01/.git" ]; then
            echo "=== Git repository exists. Pulling latest changes ==="
            cd /home/ec2-user/ncc01
            git fetch --prune
            git checkout master
            git pull origin master
          elif [ -d "/home/ec2-user/ncc01" ]; then
            echo "=== Directory exists but not a git repository. Removing and cloning ==="
            rm -rf /home/ec2-user/ncc01
            cd /home/ec2-user
            git clone ${{ github.server_url }}/${{ github.repository }}.git ncc01
            cd ncc01
            git checkout master
          else
            echo "=== Directory not found. Cloning repository ==="
            cd /home/ec2-user
            git clone ${{ github.server_url }}/${{ github.repository }}.git ncc01
            cd ncc01
            git checkout master
          fi

          # 現在のディレクトリとファイル一覧を表示（デバッグ用）
          echo "=== Current directory ==="
          pwd
          echo "=== Files in current directory ==="
          ls -la

          # Dockerfile を検索
          echo "=== Searching for Dockerfile ==="
          DOCKERFILE_PATH=""
          if [ -f "Dockerfile" ]; then
            DOCKERFILE_PATH="."
            echo "Found Dockerfile in root directory"
          elif [ -f "docker/Production/Dockerfile" ]; then
            DOCKERFILE_PATH="docker/Production"
            echo "Found Dockerfile in docker/Production/ directory"
          elif [ -f "docker/Staging/Dockerfile" ]; then
            DOCKERFILE_PATH="docker/Staging"
            echo "Found Dockerfile in docker/Staging/ directory"
          elif [ -f "docker/Local/Dockerfile" ]; then
            DOCKERFILE_PATH="docker/Local"
            echo "Found Dockerfile in docker/Local/ directory"
          elif [ -f "docker/Dockerfile" ]; then
            DOCKERFILE_PATH="docker"
            echo "Found Dockerfile in docker/ directory"
          elif [ -f "backend/Dockerfile" ]; then
            DOCKERFILE_PATH="backend"
            echo "Found Dockerfile in backend/ directory"
          else
            echo "ERROR: Dockerfile not found in the following locations:"
            echo "  - ./Dockerfile"
            echo "  - ./docker/Production/Dockerfile"
            echo "  - ./docker/Staging/Dockerfile"
            echo "  - ./docker/Local/Dockerfile"
            echo "  - ./docker/Dockerfile"
            echo "  - ./backend/Dockerfile"
            echo ""
            echo "Searching entire repository:"
            find . -name "Dockerfile" -type f 2>/dev/null || echo "No Dockerfile found"
            exit 1
          fi

          echo "=== Docker build ==="
          cd /home/ec2-user/ncc01
          echo "Building from directory: $(pwd)"
          docker build \
            --build-arg WWWGROUP=1000 \
            --build-arg WWWUSER=1000 \
            -f "$DOCKERFILE_PATH" \
            -t ncc01_laravel.ncc_1:latest \
            .
          echo "=== Build completed successfully ==="
          EOF

          # クリーンアップ
          rm -f private_key

      # セキュリティグループを閉じる
      - name: Close Security Group
        if: always()
        run: |
          aws ec2 revoke-security-group-ingress --group-id ${{ secrets.EC2_SECURITY_GROUP_ID }} --protocol tcp --port 22 --cidr ${{ steps.ip.outputs.ipv4 }}/32 || true

  deploy:
    needs: build
    if: success()
    runs-on: ubuntu-latest
    steps:
      # Branchをチェックアウト
      - name: Checkout code
        uses: actions/checkout@v4

      # IP取得ライブラリをインストール
      - name: Public IP Install
        id: ip
        uses: haythem/public-ip@v1.3

      # AWS CLIをインストールする
      - name: AWS CLI install
        run: |
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          sudo ./aws/install --update
          aws --version

      # AWS CLIにキーを設定する
      - name: AWS set Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1

      # セキュリティグループを開放
      - name: Open Security Group
        id: open-sg
        run: |
          aws ec2 authorize-security-group-ingress --group-id ${{ secrets.EC2_SECURITY_GROUP_ID }} --protocol tcp --port 22 --cidr ${{ steps.ip.outputs.ipv4 }}/32

      # デプロイを実行
      - name: Deploy to EC2
        run: |
          # 秘密鍵を設定
          cat > private_key << 'KEYEOF'
          ${{ secrets.SSH_PRIVATE_KEY }}
          KEYEOF
          chmod 600 private_key

          # 秘密鍵の確認（デバッグ用 - 内容は表示しない）
          if [ -s private_key ]; then
            echo "Private key file created successfully"
            head -n 1 private_key
          else
            echo "ERROR: Private key file is empty"
            exit 1
          fi

          # 接続情報の確認
          echo "User: ${{ secrets.EC2_USER }}"
          echo "Host: ${{ secrets.EC2_HOST }}"

          # SSH 接続してデプロイを実行
          ssh -o StrictHostKeyChecking=no -i private_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          set -e
          echo "=== Stop old container ==="
          docker stop ncc01_laravel.ncc_1 || true
          docker rm ncc01_laravel.ncc_1 || true
          echo "=== Start new container ==="
          docker run -d --name ncc01_laravel.ncc_1 -p 80:80 ncc01_laravel.ncc_1:latest
          echo "=== Deploy completed ==="
          docker ps | grep ncc01_laravel.ncc_1
          EOF

          # クリーンアップ
          rm -f private_key

      # セキュリティグループを閉じる
      - name: Close Security Group
        if: always()
        run: |
          aws ec2 revoke-security-group-ingress --group-id ${{ secrets.EC2_SECURITY_GROUP_ID }} --protocol tcp --port 22 --cidr ${{ steps.ip.outputs.ipv4 }}/32 || true
