# SaveController テスト仕様書

## 概要
最低限必要な情報保存処理コントローラーのテスト仕様書

## テスト対象クラス
`App\Http\Controllers\Apply\MinimumInfo\SaveController`

## テスト対象メソッド
`__invoke(MinimumInfoRequest $request)`

## テストケース

### 1. 正常系

#### 1.1 最低限必要な情報を保存して申出を作成できること
- テストメソッド名：`test_最低限必要な情報を保存して申出を作成できること`

##### 前提条件
- ユーザーが認証済みであること
- セッションにスキップURL情報（skip_preliminary_ulid）が存在すること

##### 入力データ
```php
$parameters = [
    'apply_type_id' => 1,
    'skip_url_id' => 'test-skip-url'
];
$skipUrlUlid = 'test-ulid';
```

##### 期待結果
1. DBトランザクションが開始されること
2. MinimumInfoApplyCreateServiceで申出が作成されること
3. セッションからスキップ情報が削除されること
4. DBトランザクションがコミットされること
5. 情報ログが出力されること
6. 申出詳細画面（apply.detail.overview）にリダイレクトされること
7. 成功メッセージ「最低限必要な情報を登録し、申出を作成しました。詳細情報を入力してください。」が表示されること

#### 1.2 スキップURL情報がない場合は申出一覧に戻されること
- テストメソッド名：`test_スキップURL情報がない場合は申出一覧に戻されること`

##### 前提条件
- ユーザーが認証済みであること
- セッションにスキップURL情報が存在しないこと

##### 入力データ
```php
$parameters = [
    'apply_type_id' => 1,
    'skip_url_id' => null
];
```

##### 期待結果
1. DBトランザクションが開始されること
2. 申出一覧画面（apply.lists.index）にリダイレクトされること
3. エラーメッセージ「スキップURLの情報が見つかりません。申出の新規作成からやり直してください。」が表示されること

### 2. 異常系

#### 2.1 申出作成時にエラーが発生した場合は元の画面に戻されること
- テストメソッド名：`test_申出作成時にエラーが発生した場合は元の画面に戻されること`

##### 前提条件
- ユーザーが認証済みであること
- セッションにスキップURL情報が存在すること
- 申出作成処理でエラーが発生すること

##### 入力データ
```php
$parameters = [
    'apply_type_id' => 1,
    'skip_url_id' => 'test-skip-url'
];
$skipUrlUlid = 'test-ulid';
```

##### 期待結果
1. DBトランザクションが開始されること
2. DBトランザクションがロールバックされること
3. エラーログが出力されること
4. 元の画面に戻されること
5. エラーメッセージ「申出の作成に失敗しました。もう一度お試しください。」が表示されること
6. 入力値が保持されること

## テスト方法
- Mockeryを使用して外部依存（DB、Session、Log、Service）をモック化
- TestCaseを継承したユニットテストとして実装
- セットアップ時にモックオブジェクトを生成
- tearDown時にMockeryをクローズ

## 注意事項
- トランザクション制御の検証を確実に行うこと
- セッション操作の検証を確実に行うこと
- リダイレクト先URLの検証を確実に行うこと
- フラッシュメッセージの検証を確実に行うこと 